name: Build Executables

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black ruff

    - name: Check code formatting with Black
      run: |
        black --check --diff .

    - name: Lint with Ruff
      run: |
        ruff check .

  build:
    needs: code-quality  # Only build if code quality passes
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform_name: ubuntu
            binary_name: animation-tool
          - os: macos-latest
            platform_name: macos
            binary_name: animation-tool
          - os: windows-latest
            platform_name: windows
            binary_name: animation-tool.exe

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with Make (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: make distribute

    - name: Build with Make (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: make distribute

    - name: Prepare artifacts
      shell: bash
      run: |
        mkdir -p ${{ matrix.platform_name }}
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          cp dist/${{ matrix.binary_name }} ${{ matrix.platform_name }}/
        else
          cp dist/animation-tool ${{ matrix.platform_name }}/
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: animation-tool-${{ matrix.os }}
        path: |
          ${{ matrix.platform_name }}/*
          README.md

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Debug artifact structure
        run: |
          echo "Artifact structure:"
          find release-assets -type f -ls

      - name: Get version info
        id: version_info
        run: |
          # Generate consistent version info (avoid date differences between jobs)
          if [ -f "version.txt" ]; then
            VERSION=$(cat version.txt)
          elif [ -f "setup.py" ] && grep -q "version=" setup.py; then
            VERSION=$(grep "version=" setup.py | cut -d'"' -f2)
          else
            VERSION="v$(date +'%Y.%m.%d')"
          fi
          # Use GitHub run number for consistency across jobs
          TAG_NAME="release-$VERSION-$(date +'%Y%m%d')-${{ github.run_number }}"
          echo "version_number=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # Create platform-specific directories with binaries and README
          for platform in linux macos windows; do
            mkdir -p "temp-$platform"

            # Copy README to each platform directory
            if [ -f "README.md" ]; then
              cp README.md "temp-$platform/"
            elif [ -f "release-assets/animation-tool-ubuntu-latest/README.md" ]; then
              cp release-assets/animation-tool-ubuntu-latest/README.md "temp-$platform/"
            fi

            # Copy platform-specific binary
            case $platform in
              linux)
                cp release-assets/animation-tool-ubuntu-latest/ubuntu/animation-tool "temp-$platform/"
                ;;
              macos)
                cp release-assets/animation-tool-macos-latest/macos/animation-tool "temp-$platform/"
                ;;
              windows)
                cp release-assets/animation-tool-windows-latest/windows/animation-tool.exe "temp-$platform/"
                ;;
            esac

            # Create zip file with tag name from previous step
            cd "temp-$platform"
            zip -r "../release-files/animation-tool-$platform-${{ steps.version_info.outputs.tag_name }}.zip" .
            cd ..
            rm -rf "temp-$platform"
          done

          echo "Release files created:"
          ls -la release-files/

      - name: Get version info
        id: version
        run: |
          # Try to get version from your project (adjust this based on your versioning)
          if [ -f "version.txt" ]; then
            VERSION=$(cat version.txt)
          elif [ -f "setup.py" ] && grep -q "version=" setup.py; then
            VERSION=$(grep "version=" setup.py | cut -d'"' -f2)
          else
            VERSION="v$(date +'%Y.%m.%d')"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=release-$VERSION-$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_info.outputs.tag_name }}
          name: "Animation Tool ${{ steps.version_info.outputs.version_number }}"
          body: |
            ğŸ¬ **C64 Animation Tool Release**

            âœ… **Code Quality Verified**
            - Black formatting: Passed
            - Ruff linting: Passed

            ğŸ”§ **Build Info**
            - **Commit:** ${{ github.sha }}
            - **Build Date:** ${{ github.event.head_commit.timestamp }}

            ğŸ“¥ **Downloads:**
            Each zip contains the binary + README.md. Download files are named with the release tag for easy identification.
            - ğŸ§ **Linux**: Look for `animation-tool-linux-*.zip`
            - ğŸ **macOS**: Look for `animation-tool-macos-*.zip`
            - ğŸªŸ **Windows**: Look for `animation-tool-windows-*.zip`

            Built with love for the C64 demo scene!
          files: |
            release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}